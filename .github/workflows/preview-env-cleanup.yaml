name: Preview Environment Cleanup

on:  # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      NAME:  # name of service, (ex: peeq-tracking)
        required: true
        type: string
      PREVIEW_NAMESPACE:
        required: true
        type: string
      CLUSTER_NAME:
        default: 'favedom-dev'
        required: false
        type: string
      LOCATION:
        default: 'us-central1-a'
        required: false
        type: string

    secrets:
      WIF_PROVIDER:  # Workload Identity Federation Provider
        required: true
      WIF_SERVICE_ACCOUNT:  # Workload Identity Federation Service Account
        required: true
jobs:

  preview-environment-cleanup:
    timeout-minutes: 10
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:

      # - name: "GITHUB INFO"
      #   env:
      #     GITHUB_CONTEXT: ${{ toJSON(github) }}
      #   run: |-
      #     echo "PR number                         : ${{ github.event.pull_request.number }}"
      #     echo "github.event_name                 : ${{ github.event_name }}"
      #     echo "github.run_attempt                : ${{ github.run_attempt }}"
      #     echo "github.run_number                 : ${{ github.run_number }}"
      #     echo "github.event.pull_request.merged  : ${{ github.event.pull_request.merged }}"
      #     echo "==================================:=============================="
      #     echo "GITHUB_CONTEXT: ${GITHUB_CONTEXT}"

      - name: "ðŸ”§ Google Auth Token"
        if: ${{ !env.ACT }}
        id: auth-gcp-token
        uses: 'google-github-actions/auth@v0'
        with:
          token_format: 'access_token'
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      - id: 'get-credentials'
        uses: 'google-github-actions/get-gke-credentials@v0'
        with:
          cluster_name: ${{ inputs.CLUSTER_NAME }}
          location: ${{ inputs.LOCATION }}

      - name: "Delete namespace: ${{ inputs.PREVIEW_NAMESPACE }}"
        env:
          PREVIEW_NAMESPACE: ${{ inputs.PREVIEW_NAMESPACE }}
        run: |
          if [[ $(kubectl get ns | awk '{print $1}' | grep ^${PREVIEW_NAMESPACE}$) == ${PREVIEW_NAMESPACE} ]]; then
            kubectl delete namespace ${PREVIEW_NAMESPACE}
          else
            echo "SKIPPING: namespace \"${PREVIEW_NAMESPACE}\" does not exist"
          fi
